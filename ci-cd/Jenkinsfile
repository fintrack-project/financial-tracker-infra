pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-southeast-2' // Set your AWS region
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id') // Add this in Jenkins credentials
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key') // Add this in Jenkins credentials
        ECR_REPO_BACKEND = '833233524962.dkr.ecr.ap-southeast-2.amazonaws.com/financial-tracker-backend' // Replace with your ECR repo for backend
        ECR_REPO_FRONTEND = '833233524962.dkr.ecr.ap-southeast-2.amazonaws.com/financial-tracker-frontend' // Replace with your ECR repo for frontend
        ECR_REPO_DATABASE = '833233524962.dkr.ecr.ap-southeast-2.amazonaws.com/financial-tracker-db' // Replace with your ECR repo for database
    }

    stages {
        stage('Build') {
            steps {
                script {
                    // Build backend
                    dir('backend') {
                        sh 'mvn clean package'
                    }
                    // Build frontend
                    dir('frontend') {
                        sh 'npm install'
                        sh 'npm run build'
                    }
                    // Build ETL
                    dir('etl') {
                        sh 'docker build -t fintrack-etl .'
                    }
                }
            }
        }

        stage('Dockerize') {
            steps {
                script {
                    // Authenticate Docker with ECR
                    sh '''
                        aws ecr get-login-password --region $AWS_REGION | \
                        docker login --username AWS --password-stdin 833233524962.dkr.ecr.$AWS_REGION.amazonaws.com
                    '''

                    // Dockerize backend
                    dir('backend') {
                        sh 'docker build -t $ECR_REPO_BACKEND:latest .'
                    }
                    // Dockerize frontend
                    dir('frontend') {
                        sh 'docker build -t $ECR_REPO_FRONTEND:latest .'
                    }
                    // Dockerize database (if needed)
                    dir('database') {
                        sh 'docker build -t $ECR_REPO_DATABASE:latest .'
                    }
                }
            }
        }

        stage('Push Docker Images to ECR') {
            steps {
                script {
                    // Push backend image
                    sh 'docker push $ECR_REPO_BACKEND:latest'

                    // Push frontend image
                    sh 'docker push $ECR_REPO_FRONTEND:latest'

                    // Push database image (if needed)
                    sh 'docker push $ECR_REPO_DATABASE:latest'
                }
            }
        }

        stage('Deploy to AWS') {
            steps {
                script {
                    // Deploy backend to ECS
                    sh 'aws ecs update-service --cluster fintrack-cluster --service fintrack-backend-service --force-new-deployment'
                    // Deploy frontend to S3
                    sh 'aws s3 sync frontend/build s3://fintrack-frontend-bucket'
                    // Configure S3 bucket for static website hosting
                    sh 'aws s3 website s3://fintrack-frontend-bucket --index-document index.html --error-document error.html'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    // Run tests for backend
                    dir('backend') {
                        sh 'mvn test'
                    }
                    // Run tests for frontend
                    dir('frontend') {
                        sh 'npm test'
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}